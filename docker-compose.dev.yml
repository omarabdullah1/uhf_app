# Development Docker Compose Configuration
# Use this for local development with hot reload and debugging

version: '3.8'

services:
  # UHF RFID Development Environment
  rfid-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: rfid-system-dev
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - API_PORT=5000
      - RFID_CONNECTION_TYPE=serial
      - RFID_SERIAL_PORT=/dev/ttyUSB0
      - DEBUG=myuhf:*
      - CHOKIDAR_USEPOLLING=true
    ports:
      - "5000:5000"  # API server
      - "3000:3000"  # React dev server
      - "9229:9229"  # Node.js debug port
    volumes:
      - .:/app
      - node_modules:/app/rfid-server/node_modules
      - client_node_modules:/app/rfid-client/node_modules
      - /app/node_modules  # Prevent overwriting
    devices:
      - "/dev/ttyUSB0:/dev/ttyUSB0"  # Serial device mapping
    privileged: true  # Required for hardware access
    networks:
      - rfid-dev-network
    depends_on:
      - postgres-dev
    command: ["./scripts/start-dev.sh"]

  # Development Database
  postgres-dev:
    image: postgres:13-alpine
    container_name: rfid-postgres-dev
    restart: unless-stopped
    environment:
      - POSTGRES_DB=rfid_dev
      - POSTGRES_USER=rfid_dev
      - POSTGRES_PASSWORD=dev_password
    ports:
      - "5433:5432"  # Different port to avoid conflicts
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./database/dev-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - rfid-dev-network

  # Development Redis
  redis-dev:
    image: redis:6-alpine
    container_name: rfid-redis-dev
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6380:6379"  # Different port to avoid conflicts
    volumes:
      - redis_dev_data:/data
    networks:
      - rfid-dev-network

  # MailHog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: rfid-mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - rfid-dev-network

volumes:
  postgres_dev_data:
    driver: local
  redis_dev_data:
    driver: local
  node_modules:
    driver: local
  client_node_modules:
    driver: local

networks:
  rfid-dev-network:
    driver: bridge